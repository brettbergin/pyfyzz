<%- include('../layouts/main') %>

<div class="container mt-5">
  <div class="card">
    <div class="card-header bg-primary text-white">
      <h1 class="h3">Batch Summaries</h1>
    </div>
    <div class="card-body">

      <!-- Search form for package name -->
      <form action="/batches/summaries" method="POST" class="mb-4">
        <div class="form-group">
          <label for="package_name">Search by Package</label>
          <input type="text" class="form-control" id="package_name" name="package_name" placeholder="Enter Package Name">
        </div><br>
        <button type="submit" class="btn btn-primary">Search</button>
        <a href="/batches/summaries" class="btn btn-secondary">Clear</a>
      </form>

      <% if (summaries.length > 0) { %>
      <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover">
          <thead class="thead-dark">
            <tr>
              <th>
                <a href="?sort=batch_job_id&order=<%= sort === 'batch_job_id' && order === 'ASC' ? 'DESC' : 'ASC' %>">
                  Batch Job ID
                  <%= sort === 'batch_job_id' ? (order === 'ASC' ? '▲' : '▼') : '' %>
                </a>
              </th>
              <th>
                <a href="?sort=batch_summary_id&order=<%= sort === 'batch_summary_id' && order === 'ASC' ? 'DESC' : 'ASC' %>">
                  Summary ID
                  <%= sort === 'batch_summary_id' ? (order === 'ASC' ? '▲' : '▼') : '' %>
                </a>
              </th>
              <th>
                <a href="?sort=package_name&order=<%= sort === 'package_name' && order === 'ASC' ? 'DESC' : 'ASC' %>">
                  Package Name
                  <%= sort === 'package_name' ? (order === 'ASC' ? '▲' : '▼') : '' %>
                </a>
              </th>
              <th>
                <a href="?sort=exception_type&order=<%= sort === 'exception_type' && order === 'ASC' ? 'DESC' : 'ASC' %>">
                  Exception Type
                  <%= sort === 'exception_type' ? (order === 'ASC' ? '▲' : '▼') : '' %>
                </a>
              </th>
              <th>
                <a href="?sort=exception_occurences&order=<%= sort === 'exception_occurences' && order === 'ASC' ? 'DESC' : 'ASC' %>">
                  Exception Occurrences
                  <%= sort === 'exception_occurences' ? (order === 'ASC' ? '▲' : '▼') : '' %>
                </a>
              </th>
              <th>
                <a href="?sort=exception_occurences_date&order=<%= sort === 'exception_occurences_date' && order === 'ASC' ? 'DESC' : 'ASC' %>">
                  Date
                  <%= sort === 'exception_occurences_date' ? (order === 'ASC' ? '▲' : '▼') : '' %>
                </a>
              </th>
            </tr>
          </thead>
          <tbody>
            <% summaries.forEach(summary => { %>
              <tr>
                <td>
                  <a href="/batches?batch_job_id=<%= summary.batch_job_id %>"><%= summary.batch_job_id.slice(-10) %></a>
                </td>
                <td><%= summary.batch_summary_id ? summary.batch_summary_id.slice(-10) : 'N/A' %></td>
                <td>
                  <a href="/packages?batch_job_id=<%= summary.batch_job_id %>"><%= summary.package_name || 'N/A' %></a>
                </td>
                <td><%= summary.exception_type || 'None' %></td>
                <td><%= summary.exception_occurences || 0 %></td>
                <td>
                  <%= new Date(summary.exception_occurences_date).toLocaleDateString() || 'N/A' %> 
                  <%= new Date(summary.exception_occurences_date).toLocaleTimeString() || 'N/A' %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <% } else { %>
      <div class="alert alert-warning">
        <p>No summaries found for this batch job.</p>
      </div>
      <% } %>
    </div>
    <div class="card-footer text-muted">
      <p>Displaying <strong><%= summaries.length %></strong> batch summaries</p>
    </div>
  </div>
</div>
